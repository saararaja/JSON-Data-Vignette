---
title: "JSON Data - A Vignette by Saara Raja"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

```{r Packages_needed, echo=FALSE}
library(knitr)
library(httr)
library(jsonlite)
library(tidyverse)
library(tidyjson)
```

## JSON Data Overview

**JSON**, or Java Script Object Notation, Data is a purely text-based way of storing data and is the primary way of data storage/retrieval of web information.  Because of its simplistic text format, JSON data is easy to read and understand by humans, while also enabling easy data parsing by a computer, hence its popularity.  XML, an alternative text-based data interchange method, has a much more complex/verbose syntax and is more challenging for humans to code and understand, causing JSON to eclipse it as the most popular method of exchanging web information.  JSON is the most popular method of extracting data from REST APIs, so having a good understanding of the format is valuable for any analytics on web-based data.

### Data Structure
The JSON data structure is in the form of nested key-value pairs and ordered lists.  The following image shows the general format of JSON data.  The original image along with more information can be found [here](https://www.goanywhere.com/managed-file-transfer/more/tutorials/parse-json-data-into-database).

```{r image, echo=FALSE, out.width="60%"}
include_graphics("ExampleJSON2.png")
```

As we can see from the image, JSON objects are created within `{}` curly brackets and each variable is paired with its value is `"key":"value"` format.  All values are placed within double quotes, whether they are of character or numeric type.  Data can also have multiple values that is depicted using `[]` square brackets to show arrays.  Arrays are an ordered list of key-value pairs, separated by commas.

In this particular image, there is a JSON object called "orders" which has several attributes ("orderno", "date", "trackingno", etc) that are displayed as nested key-value pairs in an array .  This nested format shows that each of these variables is related to the original parent variable "orders".  In addition, the variable "customer" has further attributes of its own, which are displayed in a 3rd layer nested key-value pairs in an array.  

Further information on JSON data can be found [here](https://www.infoworld.com/article/3222851/what-is-json-a-better-format-for-data-exchange.html).

## Reading JSON Data into R
Since JSON data is purely text-based, it needs to be parsed in order to use in databases or in programming platforms.  To read and parse JSON data into R, there are 4 main packages: `rjson`, `rjsonio`, `jsonlite`, and `tidyjson`.

### rjson and rjsonio
Both `rjson` and `rjsonio` have the same functionality and same basic interface.  `rjson` was the first package created for translating between R and json, and `rjsonio` was created subsequently to perform the same task more quickly, though now both packages have comparable efficiency.

Both packages have two basic functions: `fromJSON("file.json")` for converting json files into R objects and `toJSON(x)` to convert an R object x into a json file.

### jsonlite

### tidyjson




## Example Analysis using JSON Data

### Connect to NHL Data

```{r Read_In_1}

base <- "https://records.nhl.com/site/api"

franch_func <- function(){
  
  #url ending
  endpoint <- "/franchise"
  
  #Create the url & read in the data 
  call1 <- paste0(base, endpoint)
  get_json <- GET(call1)
  get_json_text <- content(get_json, "text")
  
  #use tidyjson to convert the data into a useable dataframe
  df_prelim <- get_json_text %>% enter_object(data) %>% gather_array %>% spread_all
  df <- as_tibble(df_prelim) 
  df <- df %>% select(-document.id, -array.index)
  return(df)
}
```

```{r}
franchise <- franch_func() 
franchise
```


```{r Read_in_2}

franch_total_func <- function(){
  
  #url ending
  endpoint <- "/franchise-team-totals"
  
  #Create the url & read in the data 
  call1 <- paste0(base, endpoint)
  get_json <- GET(call1)
  get_json_text <- content(get_json, "text")
  
  #use tidyjson to convert the data into a useable dataframe
  df_prelim <- get_json_text %>% enter_object(data) %>% gather_array %>% spread_all
  df <- as_tibble(df_prelim) 
  df <- df %>% select(-document.id, -array.index)
  return(df)
}
```

```{r Call_total}
franch_total <- franch_total_func()
franch_total
```


```{r Read_in_3}

franch_season_func <- function(number){
  
  #url ending
  endpoint <- "/franchise-season-records?cayenneExp=franchiseId="
  
  #Create the url & read in the data 
  call1 <- paste0(base, endpoint, number)
  get_json <- GET(call1)
  get_json_text <- content(get_json, "text")
  
  #use tidyjson to convert the data into a useable dataframe
  df_prelim <- get_json_text %>% enter_object(data) %>% gather_array %>% spread_all
  df <- as_tibble(df_prelim) 
  df <- df %>% select(-document.id, -array.index)
  return(df)
}
```

```{r Call_3}
franch_season <- franch_season_func(3)
franch_season
```

```{r Read_in_4}

franch_goalie_func <- function(number){
  
  #url ending
  endpoint <- "/franchise-goalie-records?cayenneExp=franchiseId="
  
  #Create the url & read in the data 
  call1 <- paste0(base, endpoint, number)
  get_json <- GET(call1)
  get_json_text <- content(get_json, "text")
  
  #use tidyjson to convert the data into a useable dataframe
  df_prelim <- get_json_text %>% enter_object(data) %>% gather_array %>% spread_all
  df <- as_tibble(df_prelim) 
  df <- df %>% select(-document.id, -array.index)
  return(df)
}
```
```{r Call_4}
franch_goalie <- franch_goalie_func(3)
franch_goalie
```

```{r Read_in_5}

franch_skater_func <- function(number){
  
  #url ending
  endpoint <- "/franchise-skater-records?cayenneExp=franchiseId="
  
  #Create the url & read in the data 
  call1 <- paste0(base, endpoint, number)
  get_json <- GET(call1)
  get_json_text <- content(get_json, "text")
  
  #use tidyjson to convert the data into a useable dataframe
  df_prelim <- get_json_text %>% enter_object(data) %>% gather_array %>% spread_all
  df <- as_tibble(df_prelim) 
  df <- df %>% select(-document.id, -array.index)
  return(df)
}
```

```{r Call_5}
franch_skater <- franch_skater_func(3)
franch_skater
```